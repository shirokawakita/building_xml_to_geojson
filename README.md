# 基盤地図情報 XML to GeoJSON 変換ツール

国土地理院が提供する基盤地図情報のXML形式データをGeoJSON形式に変換するPythonスクリプトです。

## 機能

- 基盤地図情報のZIPファイルからXMLデータを自動抽出
- GML形式のXMLデータをGeoJSONに変換
- 複数の地域データを統合して単一のGeoJSONファイルに出力
- **複数のZIPファイルを同時に処理して結合**（Streamlitアプリ）
- コマンドライン引数による柔軟なファイル指定
- 高速処理による大量データの効率的な変換
- Streamlit Webアプリによる直感的な操作
- HTML WebアプリによるGeoJSONデータの地図表示
- 国土地理院地図を背景としたデータの可視化

## 対応データタイプ

現在の実装では、以下のデータタイプに対応しています：

- **建物データ（-BldA-）**: 建物ポリゴンデータの変換に対応

その他のデータタイプ（行政区域、道路、水涯線など）についても、同様の方法で変換可能です。

## 使用方法

### Streamlitアプリ（推奨）

複数のZIPファイルを簡単に処理できるWebアプリです。

```bash
# Streamlitアプリを起動
streamlit run streamlit_app.py
```

**主な機能:**

1. **複数ファイル対応**
   - 複数の基盤地図情報ZIPファイルを同時にアップロード可能
   - メインZIPファイル（中にサブZIPファイルが入っている）とサブZIPファイル（直接XMLファイルが入っている）の両方に対応
   - すべての建物ポリゴンを自動的に結合して一つのGeoJSONファイルとして出力

2. **リアルタイム処理**
   - リアルタイムの進捗表示（プログレスバーとステータス表示）
   - 処理中のファイル名と進捗状況を表示
   - 処理完了時に統計情報を表示（処理ファイル数、建物数、ファイルサイズ）

3. **出力ファイル名の自動生成**
   - 1つのファイルの場合: `{ZIPファイル名}_buildings.geojson`
   - 複数のファイルの場合: `{最初のZIPファイル名}_merged_buildings.geojson`
   - 入力ファイル名が出力ファイル名に含まれるため、どのファイルから生成されたかが分かりやすい

4. **データの追跡性**
   - 各建物データの`properties`に`source_file`プロパティが追加される
   - どのZIPファイルから抽出された建物データかが分かる

5. **使いやすいUI**
   - ドラッグ&ドロップでファイルをアップロード
   - ワンクリックでGeoJSONファイルをダウンロード
   - 変換結果のプレビュー表示（最初の10件）

### コマンドライン版

```bash
# 高速版（推奨）
python xml_to_geojson_fast.py <基盤地図情報のZIPファイル>

# 標準版
python xml_to_geojson.py <基盤地図情報のZIPファイル>
```

### 出力ファイル名を指定する場合

```bash
python xml_to_geojson_fast.py 20250918090652709-001.zip -o output.geojson
```

### テスト用（少量データ）

```bash
# 最初の5つのファイルのみ処理
python xml_to_geojson_fast.py 20250918090652709-001.zip --max-files 5 -o test.geojson
```

### 使用例

```bash
# 基本的な変換（高速版）
python xml_to_geojson_fast.py 20250918090652709-001.zip

# カスタム出力ファイル名
python xml_to_geojson_fast.py data.zip -o output.geojson

# テスト用（最初の1ファイルのみ）
python xml_to_geojson_fast.py data.zip --max-files 1 -o test.geojson
```

## Webアプリでの地図表示

変換したGeoJSONファイルを地図上で閲覧するためのHTML Webアプリが含まれています。

### Webアプリの使用方法

1. **Webアプリを開く**
   ```bash
   # ブラウザでgeojson_viewer.htmlを開く
   start geojson_viewer.html  # Windows
   open geojson_viewer.html   # macOS
   ```

2. **GeoJSONファイルを読み込み**
   - 右上のコントロールパネルで「ファイルを選択」をクリック
   - 変換したGeoJSONファイルを選択

3. **地図表示の操作**
   - ポリゴンの表示/非表示切り替え
   - マーカーの表示/非表示切り替え
   - 背景地図の切り替え（国土地理院地図、OpenStreetMap）
   - フィーチャーをクリックして詳細情報を表示

### Webアプリの機能

- **背景地図**: 国土地理院の標準地図、淡色地図、色別標高図、空中写真
- **データ表示**: ポリゴン表示とマーカー表示の切り替え
- **インタラクティブ操作**: ズーム、パン、クリックで詳細表示
- **情報パネル**: フィーチャー数、ファイル名、現在位置の表示
- **フルスクリーン表示**: 大画面での閲覧に対応

## 引数

- `zip_file`: 基盤地図情報のZIPファイルパス（必須）
- `-o, --output`: 出力ファイル名（デフォルト: buildings.geojson）
- `--max-files`: 処理するサブZIPファイルの最大数（テスト用）

## 出力

変換されたGeoJSONファイルには以下の情報が含まれます：

- **geometry**: 地理的データの座標（WGS84座標系）
  - ポリゴン、ライン、ポイントなどのジオメトリタイプに対応
- **properties**: データの属性情報
  - `source_file`: 元のZIPファイル名（Streamlitアプリ使用時のみ）
  - データタイプに応じた属性情報（fid、type、orgGILvl、gml_idなど）

### 出力ファイル名（Streamlitアプリ）

- **1つのZIPファイル**: `{ZIPファイル名}_buildings.geojson`
  - 例: `20250918090652709-001.zip` → `20250918090652709-001_buildings.geojson`
- **複数のZIPファイル**: `{最初のZIPファイル名}_merged_buildings.geojson`
  - 例: `20250918090652709-001.zip`, `FG-GML-4983017-ALL-20161001.zip` → `20250918090652709-001_merged_buildings.geojson`

## ファイル構成

```
xml_to_geojson/
├── streamlit_app.py           # Streamlit Webアプリ（推奨）
├── xml_to_geojson.py          # 標準版変換スクリプト
├── xml_to_geojson_fast.py     # 高速版変換スクリプト
├── xml_to_geojson_gpd.py      # GeoPandas版変換スクリプト
├── geojson_viewer.html        # HTML版地図表示アプリ
├── requirements.txt           # 必要なライブラリ
└── README.md                  # このファイル
```

## 基盤地図情報のファイル構造

基盤地図情報のZIPファイルは以下の構造になっています：

```
メインZIPファイル
├── 地域1.zip
│   ├── FG-GML-XXXXX-BldA-YYYYMMDD-0001.xml  (建物データ)
│   ├── FG-GML-XXXXX-AdmBdry-YYYYMMDD-0001.xml  (行政区域)
│   ├── FG-GML-XXXXX-RdEdg-YYYYMMDD-0001.xml  (道路縁)
│   └── その他のファイル
├── 地域2.zip
│   └── ...
└── ...
```

このスクリプトは、メインZIPファイル内のすべてのサブZIPファイルを自動的に処理し、指定されたデータタイプ（現在は-BldA-）を含むXMLファイルを検索して変換します。

**Streamlitアプリでは、以下の両方の形式に対応しています：**
- メインZIPファイル（中にサブZIPファイルが入っている）
- サブZIPファイル（直接XMLファイルが入っている、例: `FG-GML-4983017-ALL-20161001.zip`）

## 必要な環境

### Streamlitアプリ用

- Python 3.7以上
- Streamlit 1.28.0以上
- 標準ライブラリのみ使用（追加の依存関係は不要）

### コマンドライン版用

- Python 3.6以上
- 標準ライブラリのみ使用（追加の依存関係は不要）

### 推奨環境

- conda環境での実行を推奨
- 大量データ処理の場合は十分なメモリ（8GB以上）を推奨

### HTML Webアプリ用

- モダンなWebブラウザ（Chrome、Firefox、Safari、Edge）
- インターネット接続（国土地理院地図の読み込み用）

## 使用例

### 1. Streamlitアプリを使用（推奨）

```bash
# Streamlitアプリを起動
streamlit run streamlit_app.py
```

**操作手順：**

1. **ファイルのアップロード**
   - ブラウザでアプリが開いたら、ファイルアップローダーで複数のZIPファイルを選択
   - メインZIPファイルとサブZIPファイルを混在してアップロード可能
   - ドラッグ&ドロップでもアップロード可能

2. **変換の実行**
   - 「🔄 変換開始」ボタンをクリック
   - プログレスバーで処理の進捗を確認
   - 各ファイルの処理状況がリアルタイムで表示される

3. **結果の確認とダウンロード**
   - 処理完了後、統計情報（処理ファイル数、建物数、ファイルサイズ）が表示される
   - 「📥 GeoJSONファイルをダウンロード」ボタンで結合されたGeoJSONファイルをダウンロード
   - 出力ファイル名には入力ZIPファイル名が含まれる
   - 変換結果のプレビュー（最初の10件）を確認可能

**対応ファイル形式：**
- メインZIPファイル: `20250918090652709-001.zip`（中にサブZIPファイルが入っている）
- サブZIPファイル: `FG-GML-4983017-ALL-20161001.zip`（直接XMLファイルが入っている）

### 2. コマンドライン版を使用

```bash
# 1. 基盤地図情報をGeoJSONに変換
python xml_to_geojson_fast.py 20250918090652709-001.zip -o output.geojson

# 2. HTML Webアプリで地図表示
# ブラウザでgeojson_viewer.htmlを開いてoutput.geojsonを読み込み
```

### 3. テスト用の少量データ処理

```bash
# 最初の5ファイルのみ処理してテスト
python xml_to_geojson_fast.py data.zip --max-files 5 -o test.geojson
```

## 注意事項

- 基盤地図情報のXMLファイルはGML形式で記述されています
- 座標系は日本測地系2000（JGD2000）または世界測地系（WGS84）です
- 大きなファイルを処理する場合は、十分なメモリとディスク容量が必要です
- Webアプリは国土地理院の地図タイルを使用するため、インターネット接続が必要です
- 現在の実装は建物データ（-BldA-）に特化していますが、他のデータタイプにも対応可能です

## トラブルシューティング

### XMLパースエラーが発生する場合

- ZIPファイルが破損していないか確認してください
- ファイルが完全にダウンロードされているか確認してください
- XMLファイルの形式が正しいか確認してください

### データが見つからない場合

- ZIPファイル内に対応するデータタイプを含むXMLファイルが存在するか確認してください
- 基盤地図情報の正しいファイルを使用しているか確認してください
- 現在の実装は建物データ（-BldA-）に特化しているため、他のデータタイプの場合はスクリプトの修正が必要です

### メモリ不足が発生する場合

- より小さな地域のデータに分割して処理してください
- `--max-files`オプションを使用して処理するファイル数を制限してください
- システムのメモリを増設することを検討してください

### Webアプリで地図が表示されない場合

- ブラウザのJavaScriptが有効になっているか確認してください
- インターネット接続を確認してください
- ブラウザのコンソールでエラーメッセージを確認してください

## ライセンス

このツールは基盤地図情報のデータを処理するためのものです。基盤地図情報の利用規約に従ってご利用ください。

## 更新履歴

- v1.1.0: Streamlitアプリ追加
  - Streamlit Webアプリによる直感的な操作
  - 複数のZIPファイルを同時に処理して結合
  - メインZIPファイルとサブZIPファイルの両方に対応
  - 出力ファイル名にZIPファイル名を含む
  - 各建物データに元のZIPファイル名（source_file）を追加
  - リアルタイムの進捗表示と統計情報の表示

- v1.0.0: 初回リリース
  - XML to GeoJSON変換機能
  - HTML Webアプリによる地図表示機能
  - 国土地理院地図との連携
  - 建物データ（-BldA-）の変換に対応

